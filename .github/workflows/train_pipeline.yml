name: train-and-register

on:
  push:
    branches:
      - main
    paths:
      - 'backend/src/**'
      - 'backend/pipeline.yaml'
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    outputs:
      job_id: ${{ steps.submit.outputs.job_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ML extension
        run: |
          az extension add -n ml

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Submit Pipeline Job
        id: submit
        run: |
          JOB_ID=$(az ml job create \
            --file backend/pipeline.yaml \
            --resource-group rg-nathan-mpops \
            --workspace-name ws-aaron-mlops \
            --query name -o tsv)

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Stream Logs
        run: |
          az ml job stream \
            --name ${{ steps.submit.outputs.job_id }} \
            --resource-group rg-nathan-mpops \
            --workspace-name ws-aaron-mlops

  download:
    needs: train
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Download and Move Model Artifact
        run: |
          # 1. SETUP AZURE CLI ENVIRONMENT
          az extension add -n ml -y
          az configure --defaults group=rg-nathan-mpops workspace=ws-aaron-mlops
          
          # 2. GET MODEL VERSION
          MODEL_VERSION=$(az ml model list --name spam-classifier --query "sort_by(@,&version)[-1].version" -o tsv)
          if [ -z "$MODEL_VERSION" ]; then
            echo "No registered versions found for spam-classifier"; exit 1; fi
          
          DOWNLOAD_TEMP="model_download_root"
          mkdir -p "$DOWNLOAD_TEMP"
          
          echo "Downloading model version $MODEL_VERSION to $DOWNLOAD_TEMP..."
          # 3. DOWNLOAD MODEL
          az ml model download \
            --name spam-classifier \
            --version "$MODEL_VERSION" \
            --download-path "$DOWNLOAD_TEMP"
          
          echo "Download complete. Finding and moving nested files..."
          
          # 4. LOCATE THE MLflow MODEL ROOT (Find MLmodel then parent directory)
          FOUND_MLMODEL=$(find "$DOWNLOAD_TEMP" -type f -name MLmodel -print -quit)
          
          if [ -n "$FOUND_MLMODEL" ]; then
            MODEL_ROOT=$(dirname "$FOUND_MLMODEL")
            echo "MLflow Model files found in: $MODEL_ROOT"
            mkdir -p inference
            mv "$MODEL_ROOT"/* inference/
            rm -rf "$DOWNLOAD_TEMP"
            echo "✅ Model files successfully moved and staged in inference/"
            echo "Final file tree under inference/:"; ls -R inference
          else
            echo "❌ No MLflow MLmodel file found after download."
            ls -R "$DOWNLOAD_TEMP" || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-config
          path: inference
    # (Optional deploy job removed for clarity; re-add when needed.)